# .devcontainer/docker-compose.yml

version: '3.8'

services:
  # 您的開發容器 (VS Code 連線用)
  app:
    build:
      context: ..
      dockerfile: .devcontainer/Dockerfile
    volumes:
      - ..:/app:cached
    user: root
    command: sleep infinity
    networks:
      - airflow_network

  # --- 新增 PHP 服務 ---
  php-app:
    image: php:8.1-apache
    container_name: php_dev_server
    ports:
      - "8081:80"
    volumes:
      - ..:/var/www/html
    networks:
      - airflow_network

  # --- Airflow Webserver ---
  airflow-webserver:
    build:
      context: ..
      dockerfile: .devcontainer/Dockerfile
    container_name: airflow_webserver
    volumes:
      - ..:/app:cached
    environment:
      - AIRFLOW__CORE__LOAD_EXAMPLES=False
      - AIRFLOW__CORE__DAGS_FOLDER=/app/dags
      - AIRFLOW__CORE__DAGBAG_IMPORT_TIMEOUT=120
      - AIRFLOW_HOME=/app/airflow
    ports:
      - "8080:8080"
    # 先初始化資料庫，再啟動 webserver
    command: >
      bash -c "cd /app && 
      /root/.local/bin/poetry run airflow db init && 
      /root/.local/bin/poetry run airflow webserver"
    networks:
      - airflow_network

  # --- 新增 Airflow Scheduler (Airflow 運作必需) ---
  airflow-scheduler:
    build:
      context: ..
      dockerfile: .devcontainer/Dockerfile
    container_name: airflow_scheduler
    volumes:
      - ..:/app:cached
    environment:
      - AIRFLOW__CORE__LOAD_EXAMPLES=False
      - AIRFLOW__CORE__DAGBAG_IMPORT_TIMEOUT=120
      - AIRFLOW__CORE__DAG_FILE_PROCESSOR_TIMEOUT=120
      - AIRFLOW__CORE__DAGS_FOLDER=/app/dags
      - AIRFLOW_HOME=/app/airflow
    depends_on:
      - airflow-webserver
    command: bash -c "sleep 15 && cd /app && /root/.local/bin/poetry run airflow scheduler"
    networks:
      - airflow_network

networks:
  airflow_network:
    driver: bridge